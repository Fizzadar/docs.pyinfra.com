
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Writing Deploys &#8212; pyinfra  documentation</title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/logo_small.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using the CLI" href="cli.html" />
    <link rel="prev" title="Getting Started" href="getting_started.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="cli.html" title="Using the CLI"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Getting Started"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Home</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">

<link rel="stylesheet" type="text/css" href="_static/pyinfra.css" />

<a href="index.html" class="text-logo">
    <img src="_static/logo_small.png" height="48px" />
    pyinfra
</a>

<div class="sidebar-block">
    <div class="sidebar-toc">
        <p class="caption"><span class="caption-text">Using pyinfra</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing Deploys</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#layout">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inventory">Inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data">Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#host-data">Host Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#group-data">Group Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authenticating-with-data">Authenticating with Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-hierarchy">Data Hierarchy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#operations">Operations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#global-arguments">Global Arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-data">Using Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operation-meta">Operation Meta</a></li>
<li class="toctree-l3"><a class="reference internal" href="#facts">Facts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#includes">Includes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#config">Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hooks">Hooks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Using the CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectors.html">Connectors</a></li>
</ul>
<p class="caption"><span class="caption-text">Deploy Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="operations.html">Operations Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="facts.html">Facts Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Example Deploys</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/deploys.html">Packaging Deploys</a></li>
</ul>
<p class="caption"><span class="caption-text">How pyinfra Works</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="deploy_process.html">Executing Deploys</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/operations.html">Writing Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/facts.html">Writing Facts</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="compatibility.html">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<p class="caption"><span class="caption-text">Elsewhere</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pyinfra.com">pyinfra.com</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Fizzadar/pyinfra">pyinfra on GitHub</a></li>
</ul>

    </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Writing Deploys</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="writing-deploys">
<h1>Writing Deploys<a class="headerlink" href="#writing-deploys" title="Permalink to this headline">¶</a></h1>
<p>The definitive guide to writing <code class="docutils literal notranslate"><span class="pre">pyinfra</span></code> deploys.</p>
<dl class="docutils">
<dt>What is a <code class="docutils literal notranslate"><span class="pre">pyinfra</span></code> deploy?</dt><dd>A deploy represents a collection of inventory (hosts to target), data (configuration, templates, files) and operations (changes/state to apply to the inventory). Deploys are written in standard Python, and other packages can be used as needed.</dd>
</dl>
<div class="section" id="layout">
<h2>Layout<a class="headerlink" href="#layout" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">*.py</span></code> - top-level operations</li>
<li><code class="docutils literal notranslate"><span class="pre">inventories/*.py</span></code> - groups of hosts and individual host data</li>
<li><code class="docutils literal notranslate"><span class="pre">group_data/*.py</span></code> - arbitrary data for host groups</li>
<li><code class="docutils literal notranslate"><span class="pre">templates/*.j2</span></code> - <cite>jinja2 &lt;https://jinja.palletsprojects.com&gt;</cite> template files</li>
<li><code class="docutils literal notranslate"><span class="pre">files/*</span></code> - normal/non-template files</li>
<li><code class="docutils literal notranslate"><span class="pre">tasks/*.py</span></code> - operations to perform a specific task</li>
<li><code class="docutils literal notranslate"><span class="pre">config.py</span></code> - optional configuration and hooks</li>
</ul>
</div>
<div class="section" id="inventory">
<h2>Inventory<a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h2>
<p>Inventory files contain groups of hosts. Groups are defined as a list or tuple of hosts. For example, this inventory creates two groups, “app_servers” and “db_servers”:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># inventories/production.py</span>

<span class="n">app_servers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;app-1.net&#39;</span><span class="p">,</span>
    <span class="s1">&#39;app-2.net&#39;</span>
<span class="p">]</span>

<span class="n">db_servers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;db-1.net&#39;</span><span class="p">,</span>
    <span class="s1">&#39;db-2.net&#39;</span><span class="p">,</span>
    <span class="s1">&#39;db-3.net&#39;</span>
<span class="p">]</span>
</pre></div>
</div>
<p><strong>In addition to the groups defined in the inventory, all the hosts are added to two more groups: “all” and the name of the inventory file, in this case “production”</strong>. Both can be overriden by defining them in the inventory.</p>
</div>
<div class="section" id="data">
<span id="data-ref-label"></span><h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>Data allows you to separate deploy variables from the deploy script. With data per host and per group, you can easily build deploys that satisfy multiple environments. The <a class="reference internal" href="examples/data_multiple_environments.html"><span class="doc">data example deploy</span></a> shows this in action.</p>
<div class="section" id="host-data">
<h3>Host Data<a class="headerlink" href="#host-data" title="Permalink to this headline">¶</a></h3>
<p>Arbitrary data can be assigned in the inventory and used at deploy-time. You just pass a tuple <code class="docutils literal notranslate"><span class="pre">(hostname,</span> <span class="pre">data)</span></code> instead of just the hostname:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># inventories/production.py</span>

<span class="n">app_servers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;app-1.net&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;app-2.net&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;some_key&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="group-data">
<h3>Group Data<a class="headerlink" href="#group-data" title="Permalink to this headline">¶</a></h3>
<p>Group data files can be used to attach data to groups of host. They are placed in <code class="docutils literal notranslate"><span class="pre">group_data/&lt;group_name&gt;.py</span></code>. This means <code class="docutils literal notranslate"><span class="pre">group_data/all.py</span></code> can be used to attach data to all hosts.</p>
<p>Data files are just Python, any core types will be included:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># group_data/production.py</span>

<span class="n">app_user</span> <span class="o">=</span> <span class="s1">&#39;myuser&#39;</span>
<span class="n">app_dir</span> <span class="o">=</span> <span class="s1">&#39;/opt/myapp&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="authenticating-with-data">
<h3>Authenticating with Data<a class="headerlink" href="#authenticating-with-data" title="Permalink to this headline">¶</a></h3>
<p>Instead of passing <code class="docutils literal notranslate"><span class="pre">--key</span></code>, <code class="docutils literal notranslate"><span class="pre">--user</span></code>, etc to the CLI, or running a SSH agent, you can define these details within host and group data. The attributes available:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ssh_port</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">ssh_user</span> <span class="o">=</span> <span class="s1">&#39;ubuntu&#39;</span>
<span class="n">ssh_key</span> <span class="o">=</span> <span class="s1">&#39;~/.ssh/some_key&#39;</span>
<span class="n">ssh_key_password</span> <span class="o">=</span> <span class="s1">&#39;password for key&#39;</span>
<span class="c1"># ssh_password = &#39;Using password authorization is bad. Preferred option is ssh_key.&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="data-hierarchy">
<h3>Data Hierarchy<a class="headerlink" href="#data-hierarchy" title="Permalink to this headline">¶</a></h3>
<p>The same keys can be defined for host and group data - this means we can set a default in <em>all.py</em> and override it on a group or host basis. When accessing data, the first match in the following is returned:</p>
<ul class="simple">
<li>“Override” data passed in via CLI args</li>
<li>Host data as defined in the inventory file</li>
<li>Normal group data</li>
<li>“all” group data</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">pyinfra contains a <code class="docutils literal notranslate"><span class="pre">debug-inventory</span></code> command which can be used to explore the data output per-host for a given inventory/deploy, ie <code class="docutils literal notranslate"><span class="pre">pyinfra</span> <span class="pre">inventory.py</span> <span class="pre">debug-inventory</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="operations">
<h2>Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h2>
<p>Now that you’ve got an inventory of hosts and know how to authenticate with them, you can start writing operations. Operations are used to describe changes to make to the systems in the inventory. Operations are namespaced and imported from <code class="docutils literal notranslate"><span class="pre">pyinfra.operations</span></code>.</p>
<p>For example, this deploy will ensure that user “pyinfra” exists with home directory <code class="docutils literal notranslate"><span class="pre">/home/pyinfra</span></code>, and that the <code class="docutils literal notranslate"><span class="pre">/var/log/pyinfra.log</span></code> file exists and is owned by that user.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># deploy.py</span>

<span class="c1"># Import pyinfra modules, each containing operations to use</span>
<span class="kn">from</span> <span class="nn">pyinfra.operations</span> <span class="kn">import</span> <span class="n">server</span><span class="p">,</span> <span class="n">files</span>

<span class="c1"># Ensure the state of a user</span>
<span class="n">server</span><span class="o">.</span><span class="n">user</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;Create pyinfra user&#39;</span><span class="p">},</span>
    <span class="s1">&#39;pyinfra&#39;</span><span class="p">,</span>
    <span class="n">home</span><span class="o">=</span><span class="s1">&#39;/home/pyinfra&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Ensure the state of files</span>
<span class="n">files</span><span class="o">.</span><span class="n">file</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;Create pyinfra log file&#39;</span><span class="p">},</span>
    <span class="s1">&#39;/var/log/pyinfra.log&#39;</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s1">&#39;pyinfra&#39;</span><span class="p">,</span>
    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pyinfra&#39;</span><span class="p">,</span>
    <span class="n">permissions</span><span class="o">=</span><span class="s1">&#39;644&#39;</span><span class="p">,</span>
    <span class="n">sudo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Execute with: pyinfra my-server.net deploy.py</span>
</pre></div>
</div>
<p>Uses the <a class="reference internal" href="modules/server.html"><span class="doc">server module</span></a> and <a class="reference internal" href="modules/files.html"><span class="doc">files module</span></a>. You can see all available operations in <a class="reference internal" href="operations.html"><span class="doc">the operations index</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Pass a <code class="docutils literal notranslate"><span class="pre">set</span></code> object as the first argument to name the operation (as above), which will appear during a deploy. By default the operation module, name and arguments are shown.</p>
</div>
<div class="section" id="global-arguments">
<h3>Global Arguments<a class="headerlink" href="#global-arguments" title="Permalink to this headline">¶</a></h3>
<p>In addition to each operations having its own arguments, there are a number of keyword arguments available for all operations:</p>
<dl class="docutils">
<dt>Privilege &amp; user escalation:</dt><dd><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">sudo</span></code>: Execute/apply any changes with sudo.</li>
<li><code class="docutils literal notranslate"><span class="pre">sudo_user</span></code>: Execute/apply any changes with sudo as a non-root user.</li>
<li><code class="docutils literal notranslate"><span class="pre">use_sudo_login</span></code>: Execute <code class="docutils literal notranslate"><span class="pre">sudo</span></code> with a login shell.</li>
<li><code class="docutils literal notranslate"><span class="pre">use_sudo_password</span></code>: Whether to use a password with sudo (will ask).</li>
<li><code class="docutils literal notranslate"><span class="pre">preserve_sudo_env</span></code>: Preserve the shell environment when using sudo.</li>
<li><code class="docutils literal notranslate"><span class="pre">su_user</span></code>: Execute/apply any changes with su.</li>
<li><code class="docutils literal notranslate"><span class="pre">use_su_login</span></code>: Execute <code class="docutils literal notranslate"><span class="pre">su</span></code> with a login shell.</li>
</ul>
</dd>
<dt>Operation control:</dt><dd><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">shell_executable</span></code>: The shell to use. Defaults to <code class="docutils literal notranslate"><span class="pre">sh</span></code> (Unix) or <code class="docutils literal notranslate"><span class="pre">cmd</span></code> (Windows).</li>
<li><code class="docutils literal notranslate"><span class="pre">env</span></code>: Dictionary of environment variables to set.</li>
<li><code class="docutils literal notranslate"><span class="pre">ignore_errors</span></code>: Ignore errors when executing the operation.</li>
<li><code class="docutils literal notranslate"><span class="pre">success_exit_codes=[0]</span></code>: List of exit codes to consider a success</li>
<li><code class="docutils literal notranslate"><span class="pre">timeout</span></code>: Timeout for <em>each</em> command executed during the operation.</li>
<li><code class="docutils literal notranslate"><span class="pre">get_pty</span></code>: Whether to get a pseudoTTY when executing any commands.</li>
<li><code class="docutils literal notranslate"><span class="pre">stdin</span></code>: String or buffer to send to the stdin of any commands</li>
</ul>
</dd>
<dt>Operation execution:</dt><dd><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">parallel</span></code>: Run this operation in batches of hosts.</li>
<li><code class="docutils literal notranslate"><span class="pre">run_once</span></code>: Only execute this operation once, on the first host to see it.</li>
<li><code class="docutils literal notranslate"><span class="pre">serial</span></code>: Run this operation host by host, rather than in parallel.</li>
</ul>
</dd>
<dt>Callbacks:</dt><dd><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">on_success</span></code>: Callback function to execute on success.</li>
<li><code class="docutils literal notranslate"><span class="pre">on_error</span></code>: Callback function to execute on error.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="using-data">
<h3>Using Data<a class="headerlink" href="#using-data" title="Permalink to this headline">¶</a></h3>
<p>Adding data to inventories was <a class="reference internal" href="#data-ref-label"><span class="std std-ref">described above</span></a> - you can access it within a deploy on <code class="docutils literal notranslate"><span class="pre">host.data</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyinfra</span> <span class="kn">import</span> <span class="n">host</span>
<span class="kn">from</span> <span class="nn">pyinfra.operations</span> <span class="kn">import</span> <span class="n">server</span>

<span class="c1"># Ensure the state of a user based on host/group data</span>
<span class="n">server</span><span class="o">.</span><span class="n">user</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;Setup the app user&#39;</span><span class="p">},</span>
    <span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">app_user</span><span class="p">,</span>
    <span class="n">home</span><span class="o">=</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">app_dir</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="operation-meta">
<h3>Operation Meta<a class="headerlink" href="#operation-meta" title="Permalink to this headline">¶</a></h3>
<p>Operation meta can be used during a deploy to change the desired operations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyinfra.operations</span> <span class="kn">import</span> <span class="n">server</span>

<span class="c1"># Run an operation, collecting its meta output</span>
<span class="n">create_user</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">user</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;Create user myuser&#39;</span><span class="p">},</span>
    <span class="s1">&#39;myuser&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># If we added a user above, do something extra</span>
<span class="k">if</span> <span class="n">create_user</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
    <span class="n">server</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span> <span class="c1"># add user to sudo, etc...</span>
</pre></div>
</div>
</div>
<div class="section" id="facts">
<h3>Facts<a class="headerlink" href="#facts" title="Permalink to this headline">¶</a></h3>
<p>Facts allow you to use information about the target host to change the operations you use. A good example is switching between <cite>apt</cite> &amp; <cite>yum</cite> depending on the Linux distribution. Like data, facts are accessed using <code class="docutils literal notranslate"><span class="pre">host.fact</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyinfra</span> <span class="kn">import</span> <span class="n">host</span>
<span class="kn">from</span> <span class="nn">pyinfra.operations</span> <span class="kn">import</span> <span class="n">yum</span>

<span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">fact</span><span class="o">.</span><span class="n">linux_name</span> <span class="o">==</span> <span class="s1">&#39;CentOS&#39;</span><span class="p">:</span>
    <span class="n">yum</span><span class="o">.</span><span class="n">packages</span><span class="p">(</span>
        <span class="s1">&#39;nano&#39;</span><span class="p">,</span>
        <span class="n">sudo</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Some facts also take a single argument like the <code class="docutils literal notranslate"><span class="pre">directory</span></code> or <code class="docutils literal notranslate"><span class="pre">file</span></code> facts. The <a class="reference internal" href="facts.html"><span class="doc">facts index</span></a> lists the available facts and their arguments.</p>
</div>
<div class="section" id="includes">
<h3>Includes<a class="headerlink" href="#includes" title="Permalink to this headline">¶</a></h3>
<p>Including files can be used to break out operations into multiple files, often referred to as tasks. Files can be included using <code class="docutils literal notranslate"><span class="pre">local.include</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyinfra</span> <span class="kn">import</span> <span class="n">local</span>

<span class="c1"># Include &amp; call all the operations in tasks/install_something.py</span>
<span class="n">local</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s1">&#39;tasks/install_something.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>See more in <a class="reference internal" href="examples/groups_roles.html"><span class="doc">examples: groups &amp; roles</span></a>.</p>
</div>
</div>
<div class="section" id="config">
<h2>Config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h2>
<p>There are a number of configuration options for how deploys are managed. These can be defined at the top of a deploy file, or in a <code class="docutils literal notranslate"><span class="pre">config.py</span></code> alongside the deploy file. See <a class="reference internal" href="apidoc/pyinfra.api.config.html"><span class="doc">the full list of options &amp; defaults</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># config.py or top of deploy.py</span>

<span class="c1"># SSH connect timeout</span>
<span class="n">CONNECT_TIMEOUT</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Fail the entire deploy after 10% of hosts fail</span>
<span class="n">FAIL_PERCENT</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When added to <code class="docutils literal notranslate"><span class="pre">config.py</span></code> (vs the deploy file), these options will take effect for any CLI usage (ie <code class="docutils literal notranslate"><span class="pre">pyinfra</span> <span class="pre">host</span> <span class="pre">exec</span> <span class="pre">--</span> <span class="pre">'tail</span> <span class="pre">-f</span> <span class="pre">/var/log/syslog'</span></code>).</p>
</div>
</div>
<div class="section" id="hooks">
<h2>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h2>
<p>Deploy hooks are executed by the CLI at various points during the deploy process. These can be defined in a <code class="docutils literal notranslate"><span class="pre">config.py</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">before_connect</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">before_facts</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">before_deploy</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">after_deploy</span></code></li>
</ul>
<p>These can be used, for example, to check the right branch before connecting or to build some client-side assets locally before fact gathering. All hooks take <code class="docutils literal notranslate"><span class="pre">(data,</span> <span class="pre">state)</span></code> as arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># config.py</span>

<span class="kn">from</span> <span class="nn">pyinfra</span> <span class="kn">import</span> <span class="n">hook</span>

<span class="nd">@hook</span><span class="o">.</span><span class="n">before_connect</span>
<span class="k">def</span> <span class="nf">my_callback</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Before connect hook!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To abort a deploy, a hook can raise a <code class="docutils literal notranslate"><span class="pre">hook.Error</span></code> which the CLI will handle.</p>
<p>When executing commands locally inside a hook (i.e. <code class="docutils literal notranslate"><span class="pre">webpack</span> <span class="pre">build</span></code>), you should always use the <code class="docutils literal notranslate"><span class="pre">pyinfra.local</span></code> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@hook</span><span class="o">.</span><span class="n">before_connect</span>
<span class="k">def</span> <span class="nf">my_callback</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="c1"># Check something local is correct, etc</span>
    <span class="n">branch</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;git rev-parse --abbrev-ref HEAD&#39;</span><span class="p">)</span>
    <span class="n">app_branch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">app_branch</span>

    <span class="k">if</span> <span class="n">branch</span> <span class="o">!=</span> <span class="n">app_branch</span><span class="p">:</span>
        <span class="c1"># Raise hook.Error for pyinfra to handle</span>
        <span class="k">raise</span> <span class="n">hook</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s1">&#39;We</span><span class="se">\&#39;</span><span class="s1">re on the wrong branch (want </span><span class="si">{0}</span><span class="s1">, got </span><span class="si">{1}</span><span class="s1">)!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">branch</span><span class="p">,</span> <span class="n">app_branch</span>
        <span class="p">))</span>
</pre></div>
</div>
</div>
</div>


          </div>
            
  <nav class="footer-relations">
    <ul class="pager">
      
        <li class="previous"><a href="getting_started.html">
          <span aria-hidden="true">&larr;</span> Getting Started
        </a></li>
      
        <li class="next"><a href="cli.html">
          Using the CLI <span aria-hidden="true">&rarr;</span>
        </a></li>
      
    </ul>
  </nav>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="cli.html" title="Using the CLI"
             >next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Getting Started"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Home</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright Nick Barrett 2020 — pyinfra v0.16.2. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
  
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../_static/css/bootstrap-theme.min.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  <meta name="docsearch:version" content="latest" />
  <meta name="docsearch:language" content="en" />
  
    <title>Dynamic Execution during Deploy &#8212; pyinfra  documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/guzzle.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/logo_small.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Dynamic Inventories &amp; Data" href="dynamic_inventories_data.html" />
    <link rel="prev" title="Data Across Multiple Environments" href="data_multiple_environments.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dynamic_inventories_data.html" title="Dynamic Inventories &amp; Data"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="data_multiple_environments.html" title="Data Across Multiple Environments"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../examples.html" accesskey="U">Example Deploys</a> &#187;</li> 
      </ul>
    </div>
  <div class="container-wrapper">
    <header>
      <nav>
        <a target="_blank" href="https://pyinfra.com">pyinfra.com<span class="glyphicon glyphicon glyphicon-share" aria-hidden="true"></span></a>
        <a target="_blank" href="https://github.com/Fizzadar/pyinfra">GitHub<span class="glyphicon glyphicon glyphicon-share" aria-hidden="true"></span></a>
      </nav>

      <div id="header-sidebar">
        <a href="../index.html" class="text-logo">
            <img src="../_static/logo_small.png" />
            pyinfra <small>latest</small>
        </a>
        
<form id="main-search" class="form-inline" action="../search.html" method="GET" role="form">
  <div id="docsearch">
    <input id="search-input" name="q" type="text" class="form-control" placeholder="Search...">
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </div>
</form>
      </div>

      <div id="mobile-toggle">
        <a id="toggle-menu" href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
        <a href="../index.html" class="text-logo">
            <img src="../_static/logo_small.png" />
        </a>
      </div>
    </header>
    <div id="left-column">
      <div class="sphinxsidebar">
        <div class="sidebar-block">
    <div class="sidebar-toc">
        <p class="caption"><span class="caption-text">Using pyinfra</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-operations.html">Using Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inventory-data.html">Inventory &amp; Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arguments.html">Global Arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">Using the CLI</a></li>
</ul>
<p class="caption"><span class="caption-text">Deploy Reference</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Example Deploys</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="client_side_assets.html">Client Side Assets</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_multiple_environments.html">Data Across Multiple Environments</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Dynamic Execution during Deploy</a></li>
<li class="toctree-l2"><a class="reference internal" href="dynamic_inventories_data.html">Dynamic Inventories &amp; Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="groups_roles.html">Groups &amp; Roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="secret_storage.html">Using Secrets in pyinfra</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../connectors.html">Connectors Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operations.html">Operations Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facts.html">Facts Index</a></li>
</ul>
<p class="caption"><span class="caption-text">How pyinfra Works</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/deploys.html">Packaging Deploys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/connectors.html">Writing Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/operations.html">Writing Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/facts.html">Writing Facts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy-process.html">Deploy Execution</a></li>
</ul>
<p class="caption"><span class="caption-text">Meta</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Help &amp; Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compatibility.html">Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/reference.html">API Reference</a></li>
</ul>

    </div>
</div>
      </div>
    </div>
    
      <div id="right-column">
        
          
            <div class="admonition important">
                <p class="first admonition-title">Documentation may contain unreleased features!</p>
                <p>You are reading most recent documentation which may not have been released yet. <a href="/en/2.x/examples/dynamic_execution_deploy.html"><strong>2.x</strong></a> is the latest release version available.</p>
            </div>
          
        
        <div class="document clearer body" role="main">
          
  <div class="section" id="dynamic-execution-during-deploy">
<h1>Dynamic Execution during Deploy<a class="headerlink" href="#dynamic-execution-during-deploy" title="Permalink to this headline">Â¶</a></h1>
<p>pyinfra is designed around the idea of defining the end-state <em>before</em> executing any changes on the remote server. Generally this works well but sometimes you need the output of one command to feed into another. This can be achieved by executing Python functions mid-deploy.</p>
<p>In this example we install a service (ZeroTier) that generates a random ID for the remote host. We then use this ID to authenticate the server with the ZeroTier API.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">pyinfra.operations</span> <span class="kn">import</span> <span class="n">apt</span><span class="p">,</span> <span class="n">python</span><span class="p">,</span> <span class="n">server</span>

<span class="c1"># Assumes the repo is configured/apt is updated</span>
<span class="n">apt</span><span class="o">.</span><span class="n">packages</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Install ZeroTier&#39;</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zerotier-one&#39;</span><span class="p">],</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">authorize_server</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
    <span class="c1"># Run a command on the server and collect status, stderr and stdout</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">run_shell_command</span><span class="p">(</span><span class="s1">&#39;cat /var/lib/zerotier-one/identity.public&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">True</span>  <span class="c1"># ensure the command executed OK</span>

    <span class="c1"># First line of output is the identity</span>
    <span class="n">server_id</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Authorize via the ZeroTier API</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://my.zerotier.com/.../</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server_id</span><span class="p">))</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

<span class="n">python</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Authorize the server on ZeroTier&#39;</span><span class="p">,</span>
    <span class="n">function</span><span class="o">=</span><span class="n">authorize_server</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">server</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Execute some shell&#39;</span><span class="p">,</span>
    <span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;echo &quot;back to other operations!&quot;&#39;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>


        </div>
          
  <nav class="footer-relations">
    <ul class="pager">
      
        <li class="previous"><a href="data_multiple_environments.html">
          <span aria-hidden="true">&larr;</span> Data Across Multiple Environments
        </a></li>
      
        <li class="next"><a href="dynamic_inventories_data.html">
          Dynamic Inventories &amp; Data <span aria-hidden="true">&rarr;</span>
        </a></li>
      
    </ul>
  </nav>
    <div class="clearer"></div>
  
      </div>
      <div class="clearfix"></div>
  </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="dynamic_inventories_data.html" title="Dynamic Inventories &amp; Data"
             >next</a> |</li>
        <li class="right" >
          <a href="data_multiple_environments.html" title="Data Across Multiple Environments"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../examples.html" >Example Deploys</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("a#toggle-menu").click(function () {
    $("#left-column").slideToggle(100);
  });

  var currentIndexItem = document.querySelector('ul.current ul.current li.current');
  if (currentIndexItem) {
    currentIndexItem.scrollIntoView({'block': 'center'});
  }
</script>
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>
  <div class="footer">
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
  <script type="text/javascript">
    docsearch({
        apiKey: '25a25b5f5310f306641f9ce07dcb06eb',
        appId: 'XXGX6EX4KA',
        indexName: 'pyinfra',
        container: '#docsearch',
        searchParameters: {
          facetFilters: ["version:latest", "lang:en"],
        },
        debug: false,
    });
  </script>



  
    <script async defer data-domain="docs.pyinfra.com" src="https://stats.oxygem.com/js/index.js"></script>
  

  </body>
</html>